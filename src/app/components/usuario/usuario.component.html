<div class="content-area" [class.sidebar-expanded]="sidebarExpanded">
  <app-sidebar [userInfo]="userInfo"></app-sidebar>
  <div class="menu-container">
    <header class="header">
      <div class="header-content">
        <div class="header-left">
          <div class="header-text">
            <h1 class="title">Gestión de Usuarios</h1>
          </div>
          <img src="assets/img/LogoFraijanes.png" alt="Logo Fraijanes" class="logo">
        </div>
      </div>
    </header>
  </div>

  <div class="control-card">
    <div class="search-controls">
      <div class="search-wrapper">
        <input 
          type="text" 
          class="search-input" 
          placeholder="Buscar"
          [(ngModel)]="searchTerm"
          (input)="filterUsers()"
        >
        <button class="btn-add" (click)="showForm()" *ngIf="currentView === 'list'">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      
      <!-- Título y fecha -->
      <div class="header-info">
        <div class="date-info">
          Fecha: {{ currentDate | date:'dd/MM/yy' }}
        </div>
      </div>
    </div>
  </div>

  <div class="main-card" *ngIf="currentView === 'list'">
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Nombre Usuario</th>
            <th>Rol</th>
            <th>Correo Institucional</th>
            <th>Teléfono Institucional</th>
            <th>extensión</th>
            <th>Estado</th>
            <th>Editar</th>
            <th>Eliminar</th>
          </tr>
        </thead>
        <tbody>
          <!-- 🆕 Cambiar filteredUsers por paginatedUsers -->
          <tr *ngFor="let user of paginatedUsers" class="table-row">
            <td class="user-name" (click)="viewUser(user)">
              {{ user.nombres }} {{ user.apellidos}}
            </td>
            <td>
              {{ user.fkrol == 1 ? 'Administrador' : 
                user.fkrol == 2 ? 'Doctor' : 
                user.fkrol == 3 ? 'Enfermero' : 
                user.fkrol == 4 ? 'Psicólogo' : 
                user.fkrol == 5 ? 'Fisioterapeuta' : 
                user.fkrol == 6 ? 'Nutricionista' : 
                user.fkrol == 7 ? 'Recepcionista' : 'Sin rol' }}
            </td>
            <td>{{ user.correo }}</td>
            <td>{{ user.telinstitucional }}</td>
            <td>{{ user.extension }}</td>
            <td>
              <span class="status-badge">
                {{ user.estado == 1 ? 'Activo' : 'Inactivo' }}
              </span>
            </td>
            <td>
              <button 
                class="action-btn edit-btn" 
                (click)="editUser(user)"
                title="Editar"
              >
                Editar
              </button>
            </td>
            <td>
              <button 
                class="action-btn delete-btn" 
                (click)="deleteUser(user.idusuario!)"
                title="Eliminar"
              >
                Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Estado vacío -->
      <div *ngIf="filteredUsers.length === 0 && !loading" class="empty-state">
        <p>No se encontraron usuarios</p>
      </div>

      <!-- Loading -->
      <div *ngIf="loading" class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        Cargando usuarios...
      </div>
    </div>

    <!-- 🆕 CONTROLES DE PAGINACIÓN -->
    <div class="pagination-container" *ngIf="totalItems > 0">
      <!-- Navegación de páginas (solo si hay más de 1 página) -->
      <div class="pagination" *ngIf="totalPages > 1">
        <!-- Botón anterior -->
        <button 
          class="pagination-btn" 
          [class.disabled]="currentPage === 1"
          (click)="previousPage()"
          [disabled]="currentPage === 1"
        >
          <i class="fas fa-chevron-left"></i>
        </button>

        <!-- Primera página -->
        <button 
          *ngIf="getPages()[0] > 1"
          class="pagination-btn"
          (click)="goToPage(1)"
        >
          1
        </button>
        
        <!-- Puntos suspensivos si hay salto -->
        <span *ngIf="getPages()[0] > 2" class="pagination-dots">...</span>

        <!-- Páginas visibles -->
        <button 
          *ngFor="let page of getPages()"
          class="pagination-btn"
          [class.active]="page === currentPage"
          (click)="goToPage(page)"
        >
          {{ page }}
        </button>

        <!-- Puntos suspensivos si hay salto al final -->
        <span *ngIf="getPages()[getPages().length - 1] < totalPages - 1" class="pagination-dots">...</span>

        <!-- Última página -->
        <button 
          *ngIf="getPages()[getPages().length - 1] < totalPages"
          class="pagination-btn"
          (click)="goToPage(totalPages)"
        >
          {{ totalPages }}
        </button>

        <!-- Botón siguiente -->
        <button 
          class="pagination-btn" 
          [class.disabled]="currentPage === totalPages"
          (click)="nextPage()"
          [disabled]="currentPage === totalPages"
        >
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>

      <!-- Mostrar mensaje si solo hay una página -->
      <div *ngIf="totalPages <= 1" class="pagination-single">
        Página 1 de 1
      </div>

      <!-- Selector de elementos por página -->
      <div class="items-per-page">
        <label>Mostrar:</label>
        <select [(ngModel)]="itemsPerPage" (ngModelChange)="onItemsPerPageChange()">
          <option [value]="5">5</option>
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
        </select>
        <span>por página</span>
      </div>
    </div>
  </div>

<!-- 🎯 MODAL FORMULARIO MEJORADO -->
<div class="modal-backdrop" *ngIf="currentView === 'form'" (click)="closeModal()">
  <div class="modal-content-large" (click)="$event.stopPropagation()">
    
    <!-- Header del modal -->
    <div class="modal-header">
      <h3>
        <span *ngIf="isViewMode">Ver Usuario</span>
        <span *ngIf="!isViewMode && isEditMode">Editar Usuario</span>
        <span *ngIf="!isViewMode && !isEditMode">Nuevo Usuario</span>
      </h3>
      <button class="modal-close" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Body del modal con scroll -->
    <div class="modal-body-scroll">
      
      <!-- Sección de foto -->
      <div class="photo-section">
        <div class="photo-upload">
          <div class="photo-preview">
            <img *ngIf="selectedPhoto" [src]="selectedPhoto" alt="Preview" class="photo-img">
            <div *ngIf="!selectedPhoto" class="photo-placeholder">
              <i class="fas fa-user-circle"></i>
              <span>Foto del usuario</span>
            </div>
          </div>
          <input 
            type="file" 
            #fileInput 
            (change)="onPhotoSelected($event)" 
            accept="image/*" 
            style="display: none;"
          >
          <div *ngIf="!isViewMode" class="d-flex gap-2">
            <button type="button" class="photo-btn" (click)="fileInput.click()">
              <i class="fas fa-camera"></i> Seleccionar Foto
            </button>
          </div>
        </div>
      </div>

      <form [formGroup]="userForm" class="user-form">
        
        <!-- Información Personal -->
        <div class="form-section">
          <h4 class="section-title">
            <i class="fas fa-user"></i> Información Personal
          </h4>
          <div class="form-grid">
            <div class="form-group">
              <label>Nombres *</label>
              <input 
                type="text" 
                formControlName="nombres"
                class="form-input"
                [class.invalid]="isFieldInvalid('nombres')"
                placeholder="Ingrese nombres"
                appInputValidator
                inputType="letters"
                [allowSpaces]="true"
              >
              <div class="error-message" *ngIf="isFieldInvalid('nombres')">
                {{ getFieldError('nombres') }}
              </div>
            </div>

            <div class="form-group">
              <label>Apellidos *</label>
              <input 
                type="text" 
                formControlName="apellidos"
                class="form-input"
                [class.invalid]="isFieldInvalid('apellidos')"
                placeholder="Ingrese apellidos"
                appInputValidator
                inputType="letters"
                [allowSpaces]="true"
              >
              <div class="error-message" *ngIf="isFieldInvalid('apellidos')">
                {{ getFieldError('apellidos') }}
              </div>
            </div>

            <div class="form-group">
              <label>Profesión *</label>
              <input 
                type="text" 
                formControlName="profesion"
                class="form-input"
                [class.invalid]="isFieldInvalid('profesion')"
                placeholder="Ej: Médico, Enfermero, etc."
                appInputValidator
                inputType="letters"
                [allowSpaces]="true"
              >
              <div class="error-message" *ngIf="isFieldInvalid('profesion')">
                {{ getFieldError('profesion') }}
              </div>
            </div>

            <div class="form-group">
              <label>Fecha de Nacimiento *</label>
              <input 
                type="date" 
                formControlName="fechaNacimiento"
                class="form-input"
              >
            </div>
          </div>
        </div>

        <!-- Información de Usuario -->
        <div class="form-section">
          <h4 class="section-title">
            <i class="fas fa-key"></i> Credenciales de Usuario
          </h4>
          <div class="form-grid">
            <div class="form-group">
              <label>Usuario *</label>
              <input 
                type="text" 
                formControlName="usuario"
                class="form-input"
                [class.invalid]="isFieldInvalid('usuario')"
                placeholder="Nombre de usuario"
                appInputValidator
                inputType="alphanumeric"
                [allowSpaces]="false"
              >
              <div class="error-message" *ngIf="isFieldInvalid('usuario')">
                {{ getFieldError('usuario') }}
              </div>
            </div>

            <div class="form-group">
              <label>Rol *</label>
              <select formControlName="role" class="form-input" [class.invalid]="isFieldInvalid('role')" appInputValidator>
                <option value="">Seleccionar rol</option>
                <option value="1">Administrador</option>
                <option value="2">Doctor</option>
                <option value="3">Enfermero</option>
                <option value="4">Psicólogo</option>
                <option value="5">Fisioterapeuta</option>
                <option value="6">Nutricionista</option>
                <option value="7">Recepcionista</option>
              </select>
              <div class="error-message" *ngIf="isFieldInvalid('role')">
                {{ getFieldError('role') }}
              </div>
            </div>

            <div *ngIf="!isViewMode">
              <div class="form-group">
                <label>
                  Contraseña 
                  <span *ngIf="!isEditMode" class="required">*</span>
                  <span *ngIf="isEditMode" class="optional">(opcional)</span>
                </label>
                <input 
                  type="password" 
                  formControlName="password"
                  class="form-input"
                  [class.invalid]="isFieldInvalid('password')"
                  [placeholder]="isEditMode ? 'Dejar vacío para mantener la actual' : 'Ingrese contraseña'"
                  appInputValidator
                  inputType="any"
                >
                <div class="error-message" *ngIf="isFieldInvalid('password')">
                  {{ getFieldError('password') }}
                </div>
              </div>
            </div>

            <div *ngIf="!isViewMode">
              <div class="form-group">
                <label>
                  Confirmar Contraseña 
                  <span *ngIf="!isEditMode" class="required">*</span>
                  <span *ngIf="isEditMode" class="optional">(opcional)</span>
                </label>
                <input 
                  type="password" 
                  formControlName="confirmPassword"
                  class="form-input"
                  [class.invalid]="isFieldInvalid('confirmPassword')"
                  [placeholder]="isEditMode ? 'Confirme nueva contraseña si la cambió' : 'Confirme la contraseña'"
                  appInputValidator
                  inputType="any"
                >
                <div class="error-message" *ngIf="isFieldInvalid('confirmPassword')">
                  {{ getFieldError('confirmPassword') }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Información de Contacto -->
        <div class="form-section">
          <h4 class="section-title">
            <i class="fas fa-envelope"></i> Información de Contacto
          </h4>
          <div class="form-grid">
            <div class="form-group">
              <label>Correo Institucional *</label>
              <input 
                type="email" 
                formControlName="correo"
                class="form-input"
                [class.invalid]="isFieldInvalid('correo')"
                placeholder="usuario@institucion.com"
                appInputValidator
                inputType="email"
              >
              <div class="error-message" *ngIf="isFieldInvalid('correo')">
                {{ getFieldError('correo') }}
              </div>
            </div>

            <div class="form-group">
              <label>Confirmar Correo *</label>
              <input 
                type="email" 
                formControlName="confirmCorreo"
                class="form-input"
                [class.invalid]="isFieldInvalid('confirmCorreo')"
                placeholder="Confirme el correo"
                appInputValidator
                inputType="email"
              >
              <div class="error-message" *ngIf="isFieldInvalid('confirmCorreo')">
                {{ getFieldError('confirmCorreo') }}
              </div>
            </div>

            <div class="form-group">
              <label>Teléfono Institucional *</label>
              <input 
                type="text" 
                formControlName="telinstitucional"
                class="form-input"
                [class.invalid]="isFieldInvalid('telinstitucional')"
                placeholder="+502 2345-6789"
                appPhoneFormat
                maxlength="14"
              >
              <div class="error-message" *ngIf="isFieldInvalid('telinstitucional')">
                {{ getFieldError('telinstitucional') }}
              </div>
            </div>

            <div class="form-group">
              <label>Extensión</label>
              <input 
                type="text" 
                formControlName="extension"
                class="form-input"
                [class.invalid]="isFieldInvalid('extension')"
                placeholder="1234"
                appInputValidator
                inputType="numbers"
                [maxLength]="4"
              >
              <div class="error-message" *ngIf="isFieldInvalid('extension')">
                {{ getFieldError('extension') }}
              </div>
            </div>

            <div class="form-group">
              <label>Teléfono Personal *</label>
              <input 
                type="text" 
                formControlName="telPersonal"
                class="form-input"
                [class.invalid]="isFieldInvalid('telPersonal')"
                placeholder="+502 1234-5678"
                appPhoneFormat
                maxlength="14"
              >
              <div class="error-message" *ngIf="isFieldInvalid('telPersonal')">
                {{ getFieldError('telPersonal') }}
              </div>
            </div>

            <div class="form-group">
              <label>Puesto Laboral *</label>
              <input 
                type="text" 
                formControlName="puesto"
                class="form-input"
                [class.invalid]="isFieldInvalid('puesto')"
                placeholder="Ej: Jefe de Enfermería"
                appInputValidator
                inputType="alphanumeric"
                [allowSpaces]="true"
              >
              <div class="error-message" *ngIf="isFieldInvalid('puesto')">
                {{ getFieldError('puesto') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Contacto de Emergencia -->
        <div class="form-section">
          <h4 class="section-title">
            <i class="fas fa-exclamation-triangle"></i> Contacto de Emergencia
          </h4>
          <div class="form-grid">
            <div class="form-group">
              <label>Nombre de Contacto *</label>
              <input 
                type="text" 
                formControlName="contactoEmergencia"
                class="form-input"
                [class.invalid]="isFieldInvalid('contactoEmergencia')"
                placeholder="Nombre completo"
                appInputValidator
                inputType="letters"
                [allowSpaces]="true"
              >
              <div class="error-message" *ngIf="isFieldInvalid('contactoEmergencia')">
                {{ getFieldError('contactoEmergencia') }}
              </div>
            </div>

            <div class="form-group">
              <label>Teléfono de Emergencia *</label>
              <input 
                type="text" 
                formControlName="telEmergencia"
                class="form-input"
                [class.invalid]="isFieldInvalid('telEmergencia')"
                placeholder="+502 9876-5432"
                appPhoneFormat
                maxlength="14"
              >
              <div class="error-message" *ngIf="isFieldInvalid('telEmergencia')">
                {{ getFieldError('telEmergencia') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Información Adicional -->
        <div class="form-section">
          <h4 class="section-title">
            <i class="fas fa-clipboard"></i> Información Adicional
          </h4>
          <div class="form-grid">
            <div class="form-group full-width">
              <label>Observaciones</label>
              <textarea
                formControlName="observaciones"
                class="form-textarea"
                rows="3"
                placeholder="Notas adicionales sobre el usuario..."
                appInputValidator
                inputType="any"
              ></textarea>
            </div>

            <div class="form-group">
              <label>Estado *</label>
              <select formControlName="status" class="form-input" [class.invalid]="isFieldInvalid('status')" appInputValidator>
                <option value="">Seleccione estado</option>
                <option value="1">Activo</option>
                <option value="0">Inactivo</option>
              </select>
              <div class="error-message" *ngIf="isFieldInvalid('status')">
                {{ getFieldError('status') }}
              </div>
            </div>
          </div>
        </div>

      </form>
    </div>

    <!-- Footer fijo del modal -->
    <div class="modal-footer">
      <div *ngIf="isViewMode" class="d-flex gap-2">
        <button type="button" class="btn-cancel" (click)="closeModal()">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
      <div *ngIf="!isViewMode" class="d-flex gap-2">
        <button type="button" class="btn-cancel" (click)="closeModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button 
          type="button"
          class="btn-save" 
          (click)="onSubmit()"
          [disabled]="userForm.invalid || loading"
        >
          <span *ngIf="loading">
            <i class="fas fa-spinner fa-spin"></i> Guardando...
          </span>
          <span *ngIf="!loading">
            <i class="fas fa-save"></i> {{ isEditMode ? ' Actualizar' : ' Crear' }} Usuario
          </span>
        </button>
      </div>
    </div>

  </div>
</div>

  <!-- 👁️ VISTA DETALLE -->
  <div class="main-card" *ngIf="currentView === 'detail'">
    <div class="detail-header">
      <h3>Detalle del Usuario</h3>
      <div class="detail-actions">
        <button class="btn-edit" (click)="editUser(selectedUser!)">
          <i class="fas fa-edit"></i> Editar
        </button>
        <button class="btn-back" (click)="showList()">
          <i class="fas fa-arrow-left"></i> Volver
        </button>
      </div>
    </div>

    <div class="detail-grid" *ngIf="selectedUser">
      <div class="detail-item">
        <label>Nombre:</label>
        <span>{{ selectedUser.nombres }}</span>
      </div>
      <div class="detail-item">
        <label>Email:</label>
        <span>{{ selectedUser.correo }}</span>
      </div>
      <div class="detail-item">